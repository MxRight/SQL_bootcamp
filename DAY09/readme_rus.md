## 

## Упражнение 00 — Простая транзакция

| Упражнение 00: Простая транзакция |                                                                                                                                               |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| Папка для сдачи                   | ex00                                                                                                                                          |
| Файлы для сдачи                   | `day08_ex00.sql` с комментариями для операторов Сессии №1 и Сессии №2; скриншот вывода psql для Сессии №1; скриншот вывода psql для Сессии №2 |
| **Разрешено**                     |                                                                                                                                               |
| Язык                              | SQL                                                                                                                                           |

В этом задании вы должны использовать командную строку PostgreSQL (psql). Нужно проверить, как ваши изменения «публикуются» для других пользователей базы данных.  

Фактически вам требуется открыть **две активные сессии** (то есть два параллельных подключения через командную строку).  

Вам нужно показать доказательство, что параллельная сессия не видит изменения, пока вы не выполните команду `COMMIT`.  

**Пошагово:**  

**Сессия №1**  

- В транзакционном режиме обновите рейтинг у пиццерии «Pizza Hut» до 5 баллов.  
- Проверьте, что изменения видны в Сессии №1.  

**Сессия №2**  

- Проверьте, что изменений не видно в Сессии №2.  

**Сессия №1**  

- Опубликуйте изменения (выполните `COMMIT`).  

**Сессия №2**  

- Проверьте, что изменения теперь видны в Сессии №2.  

Пример вывода из Сессии №2:  

```
pizza_db=> select * from pizzeria where name  = 'Pizza Hut';
 id |   name    | rating
----+-----------+--------
  1 | Pizza Hut |    4.6
(1 row)

pizza_db=> select * from pizzeria where name  = 'Pizza Hut';
 id |   name    | rating
----+-----------+--------
  1 | Pizza Hut |    5
(1 row)
```

Обратите внимание: один и тот же запрос вернул разные результаты, ведь первая выборка была сделана до публикации изменений в Сессии №1, а вторая — после её завершения.  

---

## Упражнение 01 — Аномалия потерянного обновления

| Упражнение 01: Аномалия потерянного обновления |                                                                                                              |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| Папка для сдачи                                | ex01                                                                                                         |
| Файлы для сдачи                                | `day08_ex01.sql` с комментариями для операторов Сессии №1, Сессии №2; скриншоты вывода psql для обеих сессий |
| **Разрешено**                                  |                                                                                                              |
| Язык                                           | SQL                                                                                                          |

Для выполнения снова используйте psql.  

Нужны **две активные сессии**.  

Прежде чем начать, убедитесь, что уровень изоляции выставлен по умолчанию:  

```sql
SHOW TRANSACTION ISOLATION LEVEL;
```

Результат должен быть: `read committed`.  
Если это не так — установите явно:  

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

---



**Порядок действий:**  

- В обеих сессиях запросите рейтинг «Pizza Hut».  
- В Сессии №1 выполните `UPDATE` рейтинга = 4.  
- В Сессии №2 выполните `UPDATE` рейтинга = 3.6 (в том порядке, что на схеме).  

Итог: одно из обновлений «перезапишет» другое, и результат будет не тот, который вы ожидали при одновременных изменениях.  

---

## Упражнение 02 — Потерянное обновление при уровне Repeatable Read

| Упражнение 02: Потерянное обновление при Repeatable Read |                                                                                                          |
| -------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| Папка для сдачи                                          | ex02                                                                                                     |
| Файлы для сдачи                                          | `day08_ex02.sql` с комментариями для операторов Сессии №1, Сессии №2; скриншоты вывода psql обеих сессий |
| **Разрешено**                                            |                                                                                                          |
| Язык                                                     | SQL                                                                                                      |

Для выполнения используйте psql.  

Необходимо открыть две сессии.  



**Шаги:**  

- В обеих сессиях запросить рейтинг «Pizza Hut» в транзакционном режиме.  
- В Сессии №1 обновить рейтинг до 4.  
- В Сессии №2 обновить рейтинг до 3.6.  

Здесь поведение будет другим: PostgreSQL не допустит «тихой потери обновления», одна из транзакций получит конфликт.  

---

## Упражнение 03 — Аномалия неповторяющихся чтений

| Упражнение 03: Аномалия неповторяющихся чтений |                                                                                      |
| ---------------------------------------------- | ------------------------------------------------------------------------------------ |
| Папка для сдачи                                | ex03                                                                                 |
| Файлы для сдачи                                | `day08_ex03.sql` с комментариями для операторов Сессии №1, Сессии №2; скриншоты psql |
| **Разрешено**                                  |                                                                                      |
| Язык                                           | SQL                                                                                  |

Нужны две параллельные сессии.  

|                                                                                                                                                                                       |                                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| Рассмотрим антипаттерн «Неповторяющееся чтение» (Non-Repeatable Reads) на уровне изоляции `READ COMMITTED`. На схеме показано, как промежуточные изменения влияют на финальный ответ. | ![D08_08](misc/images/D08_08.png) |

**Действия:**  

- В Сессии №1 сделайте выборку рейтинга «Pizza Hut».  
- В Сессии №2 обновите рейтинг до 3.6.  
- Вернитесь в Сессию №1 и повторите выборку: увидите уже другой результат — значение «скакнуло».  

Это и есть неповторяющееся чтение.  

---

## Упражнение 04 — Неповторяющиеся чтения при уровне сериализации

| Упражнение 04: Неповторяющиеся чтения при сериализации |                                                          |
| ------------------------------------------------------ | -------------------------------------------------------- |
| Папка для сдачи                                        | ex04                                                     |
| Файлы для сдачи                                        | `day08_ex04.sql` с комментариями, скриншоты обеих сессий |
| **Разрешено**                                          |                                                          |
| Язык                                                   | SQL                                                      |

Здесь снова нужны две сессии.  

|                                                                                                                                                                                         |                                   |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| Рассмотрим тот же паттерн «Неповторяющиеся чтения», но при уровне изоляции `SERIALIZABLE`. На рисунке показаны результаты: красная линия — финальный корректный ответ после всех шагов. | ![D08_09](misc/images/D08_09.png) |

**Шаги:**  

- В Сессии №1 запросите рейтинг «Pizza Hut».  
- В Сессии №2 обновите на 3.0.  
- PostgreSQL не даст Сессии №1 увидеть противоречивый результат — одна из транзакций будет прервана.  

---

## Упражнение 05 — Аномалия фантомных чтений

| Упражнение 05: Аномалия фантомных чтений |                                                            |
| ---------------------------------------- | ---------------------------------------------------------- |
| Папка для сдачи                          | ex05                                                       |
| Файлы для сдачи                          | `day08_ex05.sql` с комментариями и скриншотами двух сессий |
| **Разрешено**                            |                                                            |
| Язык                                     | SQL                                                        |

Опять две сессии.  

|                                                                                                                                                                      |                                   |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| Рассмотрим «фантомные чтения» (phantom reads) на уровне `READ COMMITTED`. Схема показывает, что промежуточные новые строки оказывают влияние на суммирующие выборки. | ![D08_10](misc/images/D08_10.png) |

**Шаги:**  

- В Сессии №1 выполните суммирование рейтингов всех пиццерий в рамках транзакции.  
- В Сессии №2 вставьте новую запись: ресторан `'Kazan Pizza'` с рейтингом 5 и id=10.  
- В Сессии №1 снова посчитайте сумму — она изменится. Таким образом, «фантомная» строка повлияла на результат.  

---

## Упражнение 06 — Фантомные чтения при Repeatable Read

| Упражнение 06: Фантомные чтения при Repeatable Read |                                                         |
| --------------------------------------------------- | ------------------------------------------------------- |
| Папка для сдачи                                     | ex06                                                    |
| Файлы для сдачи                                     | `day08_ex06.sql` с комментариями, скриншоты двух сессий |
| **Разрешено**                                       |                                                         |
| Язык                                                | SQL                                                     |

|                                                                                |                                   |
| ------------------------------------------------------------------------------ | --------------------------------- |
| Рассмотрим тот же паттерн «фантомные чтения», но при уровне `REPEATABLE READ`. | ![D08_11](misc/images/D08_11.png) |

**Шаги:**  

- В Сессии №1 суммируйте все рейтинги.  
- В Сессии №2 вставьте новую запись: `'Kazan Pizza 2'` с рейтингом 4 и id=11.  
- В Сессии №1 сумма останется неизменной в рамках транзакции, так как поведение Repeatable Read защищает от «фантомов».  

---

## Упражнение 07 — Взаимоблокировка (Deadlock)

| Упражнение 07: Deadlock |                                                                     |
| ----------------------- | ------------------------------------------------------------------- |
| Папка для сдачи         | ex07                                                                |
| Файлы для сдачи         | `day08_ex07.sql` с комментариями и скриншотами psql для двух сессий |
| **Разрешено**           |                                                                     |
| Язык                    | SQL                                                                 |

В этом задании в двух сессиях нужно воспроизвести ситуацию взаимоблокировки.  

**Шаги:**  

- В Сессии №1 заблокируйте строку в таблице `pizzeria`.  
- В Сессии №2 попробуйте обновить ту же строку.  
- В Сессии №1 попробуйте выполнить другой `UPDATE` по строке, которую уже держит Сессия №2.  

Результат: PostgreSQL определит «патовую ситуацию» и завершит одну из транзакций с ошибкой DEADLOCK DETECTED.  