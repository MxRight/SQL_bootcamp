

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 00 ‚Äî –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 00: –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞ |                  |
| ------------------------------------------------------------------ | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                                               | ex00             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                                                    | `day05_ex00.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                                                      |                  |
| –Ø–∑—ã–∫                                                               | ANSI SQL         |

–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π BTree-–∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞ –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.  

–®–∞–±–ª–æ–Ω –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—É:  
**`idx_{table_name}_{column_name}`**

–ù–∞–ø—Ä–∏–º–µ—Ä, –∏–º—è BTree-–∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ `pizzeria_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `menu` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **`idx_menu_pizzeria_id`**.  

---

## –ì–ª–∞–≤–∞ V

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 01 ‚Äî –ö–∞–∫ –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å —Ä–∞–±–æ—Ç–∞–µ—Ç?

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 01: –ö–∞–∫ –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å —Ä–∞–±–æ—Ç–∞–µ—Ç? |                  |
| ------------------------------------------------- | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                              | ex01             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                                   | `day05_ex01.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                                     |                  |
| –Ø–∑—ã–∫                                              | ANSI SQL         |

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–∞–ø–∏—à–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∏—Ü—Ü—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∏—Ü—Ü–µ—Ä–∏–π.  
–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–∏–º (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è):  

| pizza_name   | pizzeria_name |
| ------------ | ------------- |
| cheese pizza | Pizza Hut     |
| ...          | ...           |

–¢–µ–ø–µ—Ä—å –¥–æ–∫–∞–∂–µ–º, —á—Ç–æ –∏–Ω–¥–µ–∫—Å –∑–∞—Ä–∞–±–æ—Ç–∞–ª –¥–ª—è –≤–∞—à–µ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞.  

–ü—Ä–∏–º–µ—Ä –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã **`EXPLAIN ANALYZE`**.  

–û–±—Ä–∞–∑–µ—Ü –≤—ã–≤–æ–¥–∞:  

```
...
->  Index Scan using idx_menu_pizzeria_id on menu m  (...)
...
```

**–ü–æ–¥—Å–∫–∞–∑–∫–∞**: –ø–æ–¥—É–º–∞–π—Ç–µ, –ø–æ—á–µ–º—É –≤–∞—à–∏ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é, –∏ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –∏—Ö –≤–∫–ª—é—á–∏—Ç—å. üòâ  

---

## –ì–ª–∞–≤–∞ VI

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 02 ‚Äî –§–æ—Ä–º—É–ª–∞ –≤ –∏–Ω–¥–µ–∫—Å–µ. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ?

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 02: –§–æ—Ä–º—É–ª–∞ –≤ –∏–Ω–¥–µ–∫—Å–µ. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ? |                  |
| ------------------------------------------------ | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                             | ex02             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                                  | `day05_ex02.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                                    |                  |
| –Ø–∑—ã–∫                                             | ANSI SQL         |

–°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π BTree-–∏–Ω–¥–µ–∫—Å `idx_person_name` –Ω–∞ –∫–æ–ª–æ–Ω–∫—É `name` –≤ —Ç–∞–±–ª–∏—Ü–µ `person`.  
–ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—å –∏–º–µ–Ω–∞ –ª—é–¥–µ–π **–≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ**.  

–ù–∞–ø–∏—à–∏—Ç–µ –∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª—é–±–æ–π SQL —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º (`EXPLAIN ANALYZE`), —á—Ç–æ –∏–Ω–¥–µ–∫—Å `idx_person_name` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.  

---

## –ì–ª–∞–≤–∞ VII

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 03 ‚Äî –ú—É–ª—å—Ç–∏–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –Ω–∞—à–∏—Ö —Ü–µ–ª–µ–π

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 03: –ú—É–ª—å—Ç–∏–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –Ω–∞—à–∏—Ö —Ü–µ–ª–µ–π |                  |
| ------------------------------------------------------ | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                                   | ex03             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                                        | `day05_ex03.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                                          |                  |
| –Ø–∑—ã–∫                                                   | ANSI SQL         |

–°–æ–∑–¥–∞–π—Ç–µ –º–Ω–æ–≥–æ–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π BTree-–∏–Ω–¥–µ–∫—Å `idx_person_order_multi` –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞:

```sql
SELECT person_id, menu_id, order_date
FROM person_order
WHERE person_id = 8 AND menu_id = 19;
```

–ö–æ–º–∞–Ω–¥–∞ `EXPLAIN ANALYZE` –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: **Index Only Scan**!):

```
Index Only Scan using idx_person_order_multi on person_order ...
```

–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –ª—é–±–æ–π SQL —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º (`EXPLAIN ANALYZE`), —á—Ç–æ **`idx_person_order_multi`** —Ä–∞–±–æ—Ç–∞–µ—Ç.  

---

## –ì–ª–∞–≤–∞ VIII

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 04 ‚Äî –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 04: –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö |                  |
| -------------------------------------- | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                   | ex04             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                        | `day05_ex04.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                          |                  |
| –Ø–∑—ã–∫                                   | ANSI SQL         |

–°–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π BTree-–∏–Ω–¥–µ–∫—Å `idx_menu_unique` –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `menu` –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ **`pizzeria_id`** –∏ **`pizza_name`**.  

–ù–∞–ø–∏—à–∏—Ç–µ –∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª—é–±–æ–π SQL —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º (`EXPLAIN ANALYZE`), —á—Ç–æ –∏–Ω–¥–µ–∫—Å `idx_menu_unique` —Ä–∞–±–æ—Ç–∞–µ—Ç.  

---

## –ì–ª–∞–≤–∞ IX

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 05 ‚Äî –ß–∞—Å—Ç–∏—á–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 05: –ß–∞—Å—Ç–∏—á–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö |                  |
| ------------------------------------------------ | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                             | ex05             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                                  | `day05_ex05.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                                    |                  |
| –Ø–∑—ã–∫                                             | ANSI SQL         |

–°–æ–∑–¥–∞–π—Ç–µ **—á–∞—Å—Ç–∏—á–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π** BTree-–∏–Ω–¥–µ–∫—Å `idx_person_order_order_date` –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `person_order` –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º `person_id` –∏ `menu_id`, —Å —É—á–µ—Ç–æ–º —á–∞—Å—Ç–∏—á–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–µ `order_date` –¥–ª—è –¥–∞—Ç—ã `'2022-01-01'`.  

–ö–æ–º–∞–Ω–¥–∞ `EXPLAIN ANALYZE` –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω:

```
Index Only Scan using idx_person_order_order_date on person_order ‚Ä¶
```

---

## –ì–ª–∞–≤–∞ X

## –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 06 ‚Äî –£–ª—É—á—à–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ 06: –£–ª—É—á—à–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |                  |
| ----------------------------------------- | ---------------- |
| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–¥–∞—á–∏                      | ex06             |
| –§–∞–π–ª—ã –¥–ª—è —Å–¥–∞—á–∏                           | `day05_ex06.sql` |
| **–†–∞–∑—Ä–µ—à–µ–Ω–æ**                             |                  |
| –Ø–∑—ã–∫                                      | ANSI SQL         |

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–ª–µ–¥—É—é—â–∏–π SQL **—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω—ã** (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ–≥–æ –ª–æ–≥–∏–∫—É):

```sql
SELECT
    m.pizza_name AS pizza_name,
    max(rating) OVER (PARTITION BY rating ORDER BY rating ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS k
FROM  menu m
INNER JOIN pizzeria pz ON m.pizzeria_id = pz.id
ORDER BY 1,2;
```

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π BTree-–∏–Ω–¥–µ–∫—Å `idx_1`, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —É–ª—É—á—à–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É **Execution Time** –¥–ª—è —ç—Ç–æ–≥–æ SQL.  

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ (`EXPLAIN ANALYZE`), —á—Ç–æ SQL –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ.  

**–ü–æ–¥—Å–∫–∞–∑–∫–∞**: —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ ¬´–ø–æ–∏—Å–∫ –≥—Ä—É–±–æ–π —Å–∏–ª–æ–π¬ª –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ cover-–∏–Ω–¥–µ–∫—Å–∞. –ü–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–º —É–¥–∞–ª—è–π—Ç–µ `idx_1`.  

---

–ü—Ä–∏–º–µ—Ä –º–æ–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è:

**–î–æ**:

```
Sort  (cost=26.08..26.13 rows=19 width=53) (actual time=0.247..0.254 rows=19 loops=1)
"  Sort Key: m.pizza_name, (max(pz.rating) OVER (?))"
Sort Method: quicksort  Memory: 26kB
->  WindowAgg  (cost=25.30..25.68 rows=19 width=53) (actual time=0.110..0.182 rows=19 loops=1)
        ->  Sort  (cost=25.30..25.35 rows=19 width=21) (actual time=0.088..0.096 rows=19 loops=1)
            Sort Key: pz.rating
            Sort Method: quicksort  Memory: 26kB
            ->  Merge Join  (cost=0.27..24.90 rows=19 width=21) (actual time=0.026..0.060 rows=19 loops=1)
                    Merge Cond: (m.pizzeria_id = pz.id)
                    ->  Index Only Scan using idx_menu_unique on menu m  (cost=0.14..12.42 rows=19 width=22) (actual time=0.013..0.029 rows=19 loops=1)
                        Heap Fetches: 19
                    ->  Index Scan using pizzeria_pkey on pizzeria pz  (cost=0.13..12.22 rows=6 width=15) (actual time=0.005..0.008 rows=6 loops=1)
Planning Time: 0.711 ms
Execution Time: 0.338 ms
```

**–ü–æ—Å–ª–µ**:

```
Sort  (cost=26.28..26.33 rows=19 width=53) (actual time=0.144..0.148 rows=19 loops=1)
"  Sort Key: m.pizza_name, (max(pz.rating) OVER (?))"
Sort Method: quicksort  Memory: 26kB
->  WindowAgg  (cost=0.27..25.88 rows=19 width=53) (actual time=0.049..0.107 rows=19 loops=1)
        ->  Nested Loop  (cost=0.27..25.54 rows=19 width=21) (actual time=0.022..0.058 rows=19 loops=1)
            ->  Index Scan using idx_1 on ‚Ä¶
            ->  Index Only Scan using idx_menu_unique on menu m  (cost=0.14..2.19 rows=3 width=22) (actual time=0.004..0.005 rows=3 loops=6)
‚Ä¶
Planning Time: 0.338 ms
Execution Time: 0.203 ms
```
